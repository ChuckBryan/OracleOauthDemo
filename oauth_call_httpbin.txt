CREATE OR REPLACE PROCEDURE oauth_call_httpbin AS
  -- Variables for OAuth token request
  req_token       UTL_HTTP.REQ;
  resp_token      UTL_HTTP.RESP;
  token_url       VARCHAR2(256) := 'https://localhost:7104/connect/token';
  client_id       VARCHAR2(100) := 'test-client';
  client_secret   VARCHAR2(100) := 'test-secret';
  scope           VARCHAR2(100) := 'api';
  grant_type      VARCHAR2(100) := 'client_credentials';
  token_request   VARCHAR2(500);
  token_response  VARCHAR2(4000);
  
  -- Variables for JSON parsing
  access_token    VARCHAR2(4000);
  
  -- Variables for httpbin request
  req_api         UTL_HTTP.REQ;
  resp_api        UTL_HTTP.RESP;
  api_url         VARCHAR2(256) := 'https://httpbin.org/bearer';
  api_response    VARCHAR2(32767);
  name            VARCHAR2(256);
  value           VARCHAR2(256);
  
  -- Variables for error handling
  http_error_msg  VARCHAR2(512);
BEGIN
  -- Set SSL wallet for secure connections
  UTL_HTTP.SET_WALLET('file:/path/to/your/wallet', 'wallet_password');
  
  -- Disable certificate validation for development purposes
  -- WARNING: In production, you should validate certificates!
  UTL_HTTP.SET_RESPONSE_ERROR_CHECK(FALSE);
  
  -- Step 1: Get OAuth token from your server
  BEGIN
    -- Set up token request
    token_request := 'grant_type=' || grant_type || 
                   '&client_id=' || client_id || 
                   '&client_secret=' || client_secret || 
                   '&scope=' || scope;
    
    -- Begin request for token
    req_token := UTL_HTTP.BEGIN_REQUEST(token_url, 'POST', 'HTTP/1.1');
    UTL_HTTP.SET_HEADER(req_token, 'Content-Type', 'application/x-www-form-urlencoded');
    UTL_HTTP.SET_HEADER(req_token, 'Content-Length', LENGTH(token_request));
    
    -- Write request body
    UTL_HTTP.WRITE_TEXT(req_token, token_request);
    
    -- Get response
    resp_token := UTL_HTTP.GET_RESPONSE(req_token);
    
    -- Check response status
    IF resp_token.status_code != 200 THEN
      DBMS_OUTPUT.PUT_LINE('OAuth server returned status: ' || resp_token.status_code);
      http_error_msg := 'Failed to get token. Status: ' || resp_token.status_code;
      
      -- Read and display error response
      BEGIN
        LOOP
          UTL_HTTP.READ_LINE(resp_token, value, TRUE);
          DBMS_OUTPUT.PUT_LINE(value);
        END LOOP;
      EXCEPTION
        WHEN UTL_HTTP.END_OF_BODY THEN
          NULL;
      END;
      
      UTL_HTTP.END_RESPONSE(resp_token);
      RAISE_APPLICATION_ERROR(-20001, http_error_msg);
    END IF;
    
    -- Read the token response
    token_response := '';
    BEGIN
      LOOP
        UTL_HTTP.READ_LINE(resp_token, value, TRUE);
        token_response := token_response || value;
      END LOOP;
    EXCEPTION
      WHEN UTL_HTTP.END_OF_BODY THEN
        NULL;
    END;
    
    UTL_HTTP.END_RESPONSE(resp_token);
    
    -- Output the token response for debugging
    DBMS_OUTPUT.PUT_LINE('Token Response: ' || token_response);
    
    -- Extract access token from JSON response
    -- Note: In a real environment, use APEX_JSON or JSON_OBJECT_T for proper JSON parsing
    -- This is a simple extraction just for demonstration
    access_token := SUBSTR(
      token_response,
      INSTR(token_response, '"access_token":"') + 16,
      INSTR(
        SUBSTR(token_response, INSTR(token_response, '"access_token":"') + 16),
        '"'
      ) - 1
    );
    
    DBMS_OUTPUT.PUT_LINE('Access Token: ' || access_token);
    
    -- Step 2: Call httpbin.org/bearer with the token
    req_api := UTL_HTTP.BEGIN_REQUEST(api_url, 'GET', 'HTTP/1.1');
    UTL_HTTP.SET_HEADER(req_api, 'Authorization', 'Bearer ' || access_token);
    
    resp_api := UTL_HTTP.GET_RESPONSE(req_api);
    
    -- Display httpbin.org response headers
    DBMS_OUTPUT.PUT_LINE('httpbin.org Response Status: ' || resp_api.status_code);
    FOR i IN 1 .. UTL_HTTP.GET_HEADER_COUNT(resp_api) LOOP
      UTL_HTTP.GET_HEADER(resp_api, i, name, value);
      DBMS_OUTPUT.PUT_LINE(name || ': ' || value);
    END LOOP;
    
    -- Read and display the API response
    api_response := '';
    BEGIN
      LOOP
        UTL_HTTP.READ_LINE(resp_api, value, TRUE);
        api_response := api_response || value || CHR(10);
      END LOOP;
    EXCEPTION
      WHEN UTL_HTTP.END_OF_BODY THEN
        NULL;
    END;
    
    DBMS_OUTPUT.PUT_LINE('API Response:');
    DBMS_OUTPUT.PUT_LINE(api_response);
    
    UTL_HTTP.END_RESPONSE(resp_api);
    
  EXCEPTION
    WHEN OTHERS THEN
      -- Make sure to end any open responses
      IF UTL_HTTP.IS_RESPONSE_OPEN(resp_token) THEN
        UTL_HTTP.END_RESPONSE(resp_token);
      END IF;
      
      IF UTL_HTTP.IS_RESPONSE_OPEN(resp_api) THEN
        UTL_HTTP.END_RESPONSE(resp_api);
      END IF;
      
      -- Re-raise the error
      RAISE;
  END;
END oauth_call_httpbin;
/